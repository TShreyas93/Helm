name: Deploy Prometheus to local kind (Windows self-hosted - PowerShell)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted]
    timeout-minutes: 60

    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Environment check
        run: |
          Write-Output "==== ENVIRONMENT CHECK ===="
          Write-Output "USER: $env:USERNAME"
          Write-Output "PATH: $env:PATH"
          Write-Output "Checking docker..."
          try { docker --version; docker info } catch { Write-Output "docker not available or failed" }
          Write-Output "Checking kind..."
          try { kind --version } catch { Write-Output "kind not available or failed" }
          Write-Output "Checking kubectl..."
          try { kubectl version --client --short } catch { Write-Output "kubectl not available or failed" }
          Write-Output "Checking helm..."
          try { helm version --short } catch { Write-Output "helm not available or failed" }
          $kcfg = $env:KUBECONFIG
          if (-not $kcfg) { $kcfg = Join-Path $env:USERPROFILE ".kube\config" }
          Write-Output "KUBECONFIG path: $kcfg"
          if (Test-Path $kcfg) { Write-Output "kubeconfig exists" } else { Write-Output "kubeconfig NOT found" }
          Write-Output "==== END ENV CHECK ===="

      - name: Verify cluster access
        run: |
          try {
            kubectl cluster-info
            kubectl get nodes -o wide
          } catch {
            Write-Error "kubectl cannot access cluster"
            exit 1
          }

      - name: Add Prometheus Helm repo
        run: |
          try {
            helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
            helm repo update
          } catch {
            Write-Error "helm repo add/update failed"
            exit 1
          }

      - name: Deploy Prometheus
        env:
          HELM_NAMESPACE: monitoring
        run: |
          try {
            $valuesFile = Join-Path $PWD "charts\prom-values.yaml"
            if (Test-Path $valuesFile) {
              Write-Output "Using values file: $valuesFile"
              helm upgrade --install prometheus prometheus-community/kube-prometheus-stack `
                --namespace $env:HELM_NAMESPACE --create-namespace -f $valuesFile `
                --wait --timeout 10m
            } else {
              Write-Output "No values file found; using --set overrides"
              helm upgrade --install prometheus prometheus-community/kube-prometheus-stack `
                --namespace $env:HELM_NAMESPACE --create-namespace `
                --set prometheus.prometheusSpec.maximumStartupDurationSeconds=60 `
                --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false `
                --wait --timeout 10m
            }
          } catch {
            Write-Error "Helm upgrade/install failed: $_"
            kubectl -n $env:HELM_NAMESPACE get pods -o wide | Out-Host
            kubectl -n $env:HELM_NAMESPACE get events --sort-by='.lastTimestamp' | Out-Host
            exit 1
          }

      - name: Show monitoring resources
        run: |
          Write-Output "Pods in monitoring namespace:"
          try { kubectl -n monitoring get pods -o wide } catch { Write-Output "Error listing pods" }
          Write-Output "Services in monitoring namespace:"
          try { kubectl -n monitoring get svc -o wide } catch { Write-Output "Error listing services" }

      - name: Show Prometheus CR and recent events
        run: |
          try {
            $crExists = kubectl -n monitoring get prometheus prometheus-kube-prometheus-prometheus -o name 2>$null
            if ($crExists) {
              Write-Output "Prometheus CR YAML:"
              kubectl -n monitoring get prometheus prometheus-kube-prometheus-prometheus -o yaml | Out-Host
              Write-Output "Prometheus describe:"
              kubectl -n monitoring describe prometheus prometheus-kube-prometheus-prometheus | Out-Host
            } else {
              Write-Output "Prometheus CR not found yet."
            }
          } catch {
            Write-Output "Error checking Prometheus CR: $_"
          }
          Write-Output "Recent events in monitoring namespace:"
          kubectl -n monitoring get events --sort-by='.lastTimestamp' | Out-Host

      - name: Optional: Short port-forward Grafana (only manual run)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          try {
            if (kubectl -n monitoring get svc grafana 2>$null) {
              Write-Output "Starting port-forward to Grafana (localhost:3000) for 30s..."
              $proc = Start-Process -FilePath "kubectl" -ArgumentList "-n monitoring port-forward svc/grafana 3000:80 --address 127.0.0.1" -PassThru -WindowStyle Hidden
              Start-Sleep -Seconds 30
              if ($proc -and -not $proc.HasExited) { $proc | Stop-Process -Force }
              Write-Output "Port-forward finished."
            } else {
              Write-Output "Grafana service not found; skipping."
            }
          } catch {
            Write-Output "Port-forward failed: $_"
          }
