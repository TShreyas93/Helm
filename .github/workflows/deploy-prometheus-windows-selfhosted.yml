name: Deploy Prometheus to local kind (Windows self-hosted - PowerShell)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted]
    timeout-minutes: 60

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Environment check
        run: |
          Write-Output "USER: $env:USERNAME"
          Write-Output "PATH: $env:PATH"
          Write-Output "Checking docker..."
          try { docker --version; docker info } catch { Write-Output "docker not available or failed" }
          Write-Output "Checking kind..."
          try { & kind --version } catch { Write-Output "kind not available or failed" }
          Write-Output "Checking kubectl..."
          try { & kubectl version --client --short } catch { Write-Output "kubectl not available or failed" }
          Write-Output "Checking helm..."
          try { & helm version --short } catch { Write-Output "helm not available or failed" }
          $kcfg = $env:KUBECONFIG
          if (-not $kcfg) { $kcfg = Join-Path $env:USERPROFILE ".kube\config" }
          Write-Output "KUBECONFIG: $kcfg"
          if (Test-Path $kcfg) { Write-Output "kubeconfig exists" } else { Write-Output "kubeconfig NOT found" }

      - name: Verify cluster access
        run: |
          try {
            kubectl cluster-info
            kubectl get nodes -o wide
          } catch {
            Write-Error "kubectl cannot access cluster"
            exit 1
          }

      - name: Add Prometheus helm repo
        run: |
          try {
            helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
            helm repo update
          } catch {
            Write-Error "helm repo add/update failed"
            exit 1
          }

      - name: Deploy Prometheus
        env:
          HELM_NAMESPACE: monitoring
        run: |
          $valuesFile = Join-Path $PWD "charts\prom-values.yaml"
          if (Test-Path $valuesFile) {
            Write-Output "Using values file: $valuesFile"
            & helm upgrade --install prometheus prometheus-community/kube-prometheus-stack --namespace $env:HELM_NAMESPACE --create-namespace -f $valuesFile --wait --timeout 10m
          } else {
            Write-Output "No values file found; using --set overrides"
            & helm upgrade --install prometheus prometheus-community/kube-prometheus-stack --namespace $env:HELM_NAMESPACE --create-namespace --set prometheus.prometheusSpec.maximumStartupDurationSeconds=60 --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false --wait --timeout 10m
          }

      - name: Show monitoring resources
        run: |
          Write-Output "Pods in monitoring namespace:"
          kubectl -n monitoring get pods -o wide || Write-Output "No pods or namespace"
          Write-Output "Services in monitoring namespace:"
          kubectl -n monitoring get svc -o wide || Write-Output "No services or namespace"

      - name: Show recent events
        run: |
          kubectl -n monitoring get events --sort-by='.lastTimestamp' || Write-Output "No events or namespace"
