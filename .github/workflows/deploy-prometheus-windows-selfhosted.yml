name: Deploy Prometheus to local kind (Windows self-hosted - Git Bash)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, windows, local-kind]
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show environment (Git Bash)
        # REPLACE the path below if your Git Bash is in a different location
        shell: 'C:\\Program Files\\Git\\bin\\bash.exe -l -o pipefail {0}'
        run: |
          echo "==== ENVIRONMENT CHECK ===="
          echo "USER: $(whoami)"
          echo "RUNNER_LABELS: $RUNNER_LABELS"
          echo "PATH: $PATH"
          echo "Git Bash binary: $(which bash || true)"
          docker --version || true
          docker info || true
          kind --version || true
          kubectl version --client --short || true
          helm version --short || true
          echo "KUBECONFIG: ${KUBECONFIG:-$HOME/.kube/config}"
          ls -la "${KUBECONFIG:-$HOME/.kube/config}" || true

      - name: Ensure kubectl can see cluster
        shell: 'C:\\Program Files\\Git\\bin\\bash.exe -l -o pipefail {0}'
        run: |
          kubectl cluster-info
          kubectl get nodes -o wide

      - name: Add Prometheus Helm repo
        shell: 'C:\\Program Files\\Git\\bin\\bash.exe -l -o pipefail {0}'
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          helm repo list

      - name: Deploy/Upgrade kube-prometheus-stack
        shell: 'C:\\Program Files\\Git\\bin\\bash.exe -l -o pipefail {0}'
        env:
          HELM_NAMESPACE: monitoring
        run: |
          VALUES_FILE="./charts/prom-values.yaml"
          if [ -f "$VALUES_FILE" ]; then
            helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
              --namespace "$HELM_NAMESPACE" --create-namespace -f "$VALUES_FILE" \
              --wait --timeout 10m
          else
            helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
              --namespace "$HELM_NAMESPACE" --create-namespace \
              --set prometheus.prometheusSpec.maximumStartupDurationSeconds=60 \
              --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
              --wait --timeout 10m
          fi

      - name: Wait for Prometheus pods and show status
        shell: 'C:\\Program Files\\Git\\bin\\bash.exe -l -o pipefail {0}'
        run: |
          kubectl -n monitoring get pods -o wide || true
          kubectl -n monitoring get svc -o wide || true

      - name: Show Prometheus CR and events (if exists)
        shell: 'C:\\Program Files\\Git\\bin\\bash.exe -l -o pipefail {0}'
        run: |
          if kubectl -n monitoring get prometheus prometheus-kube-prometheus-prometheus >/dev/null 2>&1; then
            kubectl -n monitoring get prometheus prometheus-kube-prometheus-prometheus -o yaml || true
            kubectl -n monitoring describe prometheus prometheus-kube-prometheus-prometheus || true
          else
            echo "Prometheus CR not found yet."
          fi
          kubectl -n monitoring get events --sort-by='.lastTimestamp' || true
