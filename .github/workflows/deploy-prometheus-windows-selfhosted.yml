name: Deploy Prometheus to local kind (Windows self-hosted - PowerShell)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted]
    timeout-minutes: 60

    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Environment check
        run: |
          Write-Output "==== ENVIRONMENT CHECK ===="
          Write-Output "USER: $env:USERNAME"
          Write-Output "PATH: $env:PATH"
          try { docker --version; docker info } catch { Write-Output "docker missing" }
          try { kind --version } catch { Write-Output "kind missing" }
          try { kubectl version --client --short } catch { Write-Output "kubectl missing" }
          try { helm version --short } catch { Write-Output "helm missing" }
          $kcfg = $env:KUBECONFIG
          if (-not $kcfg) { $kcfg = Join-Path $env:USERPROFILE ".kube\config" }
          if (Test-Path $kcfg) { Write-Output "kubeconfig found: $kcfg" } else { Write-Output "kubeconfig not found" }

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes -o wide

      - name: Add Prometheus helm repo
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Deploy Prometheus
        env:
          HELM_NAMESPACE: monitoring
        run: |
          $valuesFile = Join-Path $PWD 'charts\prom-values.yaml'
          if (Test-Path $valuesFile) {
            helm upgrade --install prometheus prometheus-community/kube-prometheus-stack --namespace $env:HELM_NAMESPACE --create-namespace -f $valuesFile --wait --timeout 10m
          } else {
            helm upgrade --install prometheus prometheus-community/kube-prometheus-stack --namespace $env:HELM_NAMESPACE --create-namespace --set prometheus.prometheusSpec.maximumStartupDurationSeconds=60 --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false --wait --timeout 10m
          }

      - name: Show monitoring resources
        run: |
          kubectl -n monitoring get pods -o wide
          kubectl -n monitoring get svc -o wide

      - name: Show events
        run: |
          kubectl -n monitoring get events --sort-by='.lastTimestamp'
